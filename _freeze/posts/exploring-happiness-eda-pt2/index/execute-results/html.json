{
  "hash": "85c5c586ab0d02eccb43d6c953e6c7de",
  "result": {
    "markdown": "---\ntitle: \"Exploring Happiness - EDA Part 2\"\nauthor: \"gregers kjerulf dubrow\"\ndate: '2023-12-21'\ncategories: [post, news, rstats, eda]\nimage: \"ice_cream_cone.jpeg\"\neditor: \n  mode: source\n---\n\n\n![Happiness in a cone](ice_cream_cone.jpeg){fig-align=\"left\" fig-alt=\"cofee ice cream cone.\"}\n\n\n\n\n\nIn [Part 1](https://www.gregdubrow.io/posts/exploring-happiness-eda/) I did some exploratory data analysis on the [World Happiness Report](https://worldhappiness.report) data for Chapter 2 of the 2023 edition.\n\nThat post got me thinking a bit about being more deliberate about my own initial workflow. Some people have project templates, but I mostly just need a starter script template. So I added some lines to my template script to really ingrain the habit of using those packages for the EDA phase. It's below...feel free to borrow and of course modify to work\n\n\n::: {.cell ECHO='true'}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for my r script template\"}\n### template for r analysis work. save as w/ appropriate name to project directory\n\nlibrary(tidyverse) # to do tidyverse things\nlibrary(tidylog) # to get a log of what's happening to the data\nlibrary(janitor) # tools for data cleaning\n\n# EDA tools\nlibrary(DataExplorer)\nlibrary(explore)\nlibrary(skimr)\n\n# some custom functions\nsource(\"~/Data/r/basic functions.R\")\n\n# sets theme as default for all plots\ntheme_set(theme_light)\n\n## ggplot helpers - load if necessary\nlibrary(patchwork) # to stitch together plots\nlibrary(ggtext) # helper functions for ggplot text\nlibrary(ggrepel) # helper functions for ggplot text\n\n\n### load data\n\n\n### clean data, redo as necesary after running basic EDA\n\n\n\n### EDA with DataExplorer, explore, skimr\n\n## DataExplorer summary of completes, missings\neda1 <- introduce(DATA)\nview(eda1)\n\n## explorer summary\nwhr23_fig2_1 %>%\n\tdescribe_tbl()\n\n## skimr summary\nDATA %>%\n\tselect() %>%\n\tskim()\n\n## go back and clean if issues seen here ##\n\n## dataexplorer plots\nplot_bar(DATA)\nplot_histogram(DATA, nrow = 5L)\n\n## dataexplorer correlations\nDATA %>%\n\tselect(or deselect as needed) %>%\n\tfilter(!is.na(if needed)) %>%\n\tplot_correlation(maxcat = 5L, type = \"continuous\", geom_text_args = list(\"size\" = 4))\n\n## dataexplorer scatterplots\nplot_scatterplot(\n\tDATA %>% select(), by = \"choose target for y axis\", nrow = 3L)\n\n## explorer shiny app\nexplore(DATA %>%\n\t\t\t\t\tselect())\n\n### continue with deeper analysis here or start new r script\n```\n:::\n\n\nBut let's get back to examining what makes people happy. By way of a quick recap:\n\n-   The WHR comes from an annual world-wide survey administered by [Gallup](https://www.gallup.com/178667/gallup-world-poll-work.aspx) and is published by the [Sustainable Development Solutions Network](https://www.unsdsn.org/).\n-   Data for Chapter 2 are made available every year, and include a 3-year rolling average of the ladder happiness score aggregated by country, other questions from the poll, and logged GDP for the country.\n\nThe EDA in part 1 showed:\n\n-   There are not many missing values in the data.\n-   All of the component variables except generosity have strong positive correlations with the happiness score.\n-   Perception of corruption has, as expected, a negative association with happiness.\n\nBut...I spaced on adding one varaible to the dataset, the GINI index, which measures *\"the extent to which the distribution of income (or, in some cases, consumption expenditure) among individuals or households within an economy deviates from a perfectly equal distribution....a Gini index of 0 represents perfect equality, while an index of 100 implies perfect inequality.\"* (from the [World Bank GINI data page](https://data.worldbank.org/indicator/SI.POV.GINI), click the `Details` tab)\n\nIt was referenced in the statistical appendix but was not included in the dataset made available. The Chapter 2 authors used two GINI values:\n\n-   a GINI of household income as reported to the Gallup survey and imputed via a STATA function, and\n-   the World Bank's GINI value, taken as the mean of GINI values from 2000 to 2022 to account for the spotty nature of by-country GINI values.\n\nWe can't do the Gallup & STATA generated GINI because we can't get the data and I don't have STATA. So we'll get the World Bank values, and add that into the data already created. Then we'll do some more EDA looking at how GINI relates to variables in the set. I was going to do some more in-depth analysis in this post, but I want to keep posts short and focused. So analysis will be in a separate post.\n\nWe'll start by loading the packages we'll use here, as well as the WHR data we already created.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for loading packages and WHR data\"}\n\nlibrary(tidyverse) # to do tidyverse things\nlibrary(tidylog) # to get a log of what's happening to the data\nlibrary(janitor) # tools for data cleaning\n\n# functions I use often enough to load them regularly...should probably write a personal package\nsource(\"~/Data/r/basic functions.R\")\n\n# load data \nwhr23_fig2_1a <- readRDS(\n\tfile = \"~/Data/r/World Happiness Report/data/whr23_fig2_1.rds\") %>%\n\t\tfilter(!is.na(ladder_score)) %>%\n\trename(region_whr = region)\n```\n:::\n\n\nTo get the GINI values you can go to the World Bank's GINI page and downloaded the latest spreadsheet, or...\n\n...even better you could use one of the helpful `r` packages to get World Bank data; Vincent Arel-Bundock's(http://arelbundock.com) [WDI](https://github.com/vincentarelbundock/WDI) and the [Geospatial Science and Human Security at Oak Ridge National Lab's](https://www.ornl.gov/gshsd) [`wbstats`](https://gshs-ornl.github.io/wbstats/). We'll use the `WDI` package here.\n\nI'll create a GINI average as per the WHR authors and I'll also extract the latest GINI value from the set. I'm not sure right now which is ultimately the best to use, but that's what a bit more EDA is for.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for loading GINI values\"}\n# using the \"extra = TRUE\" option pulls in capital city & latitude longitude, \n# region, and World Bank income & lending indicators. We won't use them in this analysis but it's\n# worth knowing they're there.\nginis = WDI::WDI(indicator='SI.POV.GINI', start=2000, end=2023, extra = TRUE) %>%\n\t\tas_tibble() %>%\n\tselect(-status, -lastupdated) %>%\n\t# fix missing regions \n\tmutate(region =\n\t\t\t\t \tcase_when(country == \"Czechia\" ~ \"Europe & Central Asia\",\n\t\t\t\t \t\t\t\t\t\tcountry == \"Viet Nam\" ~ \"East Asia & Pacific\",\n\t\t\t\t \t\t\t\t\t\tTRUE ~ region)) %>%\n\t# remove aggregated regions \n\tfilter(region != \"Aggregates\")%>%\n\tarrange(country, year) %>%\n\trename(gini = SI.POV.GINI) %>%\n\t# create the latest and average columns\n\tmutate(ginifill = gini) %>%\n\tgroup_by(country) %>%\n\tmutate(gini_avg = mean(gini, na.rm = TRUE)) %>%\n\tfill(ginifill, .direction = \"downup\") %>%\n\tungroup() %>%\n\tfilter(year == 2022) %>%\n\tmutate(gini_latest = ifelse(is.na(gini), ginifill, gini)) %>%\n\tselect(country:gini, gini_latest, ginifill, gini_avg, everything()) %>%\n\trename(country_name = country) %>%\n\t# clean up some country names to match with WHR data\n\tmutate(country_name =\n\t\t\t\t \tcase_when(country_name == \"Czechia\" ~ \"Czech Republic\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Congo, Dem. Rep.\" ~ \"Congo (Kinshasa)\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Congo, Rep.\" ~ \"Congo (Brazzaville)\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Cote d'Ivoire\" ~ \"Ivory Coast\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Egypt, Arab Rep.\" ~ \"Egypt\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Eswatini\" ~ \"Swaziland\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Gambia, The\" ~ \"Gambia\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Hong Kong SAR, China\" ~ \"Hong Kong S.A.R. of China\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Iran, Islamic Rep.\" ~ \"Iran\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Korea, Rep.\" ~ \"South Korea\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Kyrgyz Republic\" ~ \"Kyrgyzstan\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Lao PDR\" ~ \"Laos\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Russian Federation\" ~ \"Russia\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Slovak Republic\" ~ \"Slovakia\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Turkiye\" ~ \"Turkey\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Venezuela, RB\" ~ \"Venezuela\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Viet Nam\" ~ \"Vietnam\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"West Bank and Gaza\" ~ \"Palestinian Territories\",\n\t\t\t\t \t\t\t\t\t\tcountry_name == \"Yemen, Rep.\" ~ \"Yemen\",\n\t\t\t\t \t\t\t\t\t\tTRUE ~ country_name)) \n```\n:::\n\n\nI had hoped to pull in a few other indicators to add to the model. The main one I wanted was literacy. Unfortunately there were too many missing values in the UNESCO set...most European countries and a few other key countries. I then thought about public expenditure on education but was worried about colinearity with the GINI index (no, I didn't test it). So we'll stick with what we have and not cloud up the model and other analysis with too many exogenous variables. If this were a\n\nSo let's add the GINI numbers to the WHR data we already have...\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for joining GINI to WHR data\"}\nwhr23_fig2_1 <- whr23_fig2_1a %>%\n\tmerge(ginis, all = TRUE) %>%\n\tas_tibble() %>%\n\tselect(country_name, iso3c, region, region_whr, whr_year:lowerwhisker, logged_gdp_per_capita,\n\t\t\t\t gini_avg, gini_latest, everything()) %>%\n\t## fill in Taiwan, no longer in this set but still available \n\t### at https://pip.worldbank.org/country-profiles/TWN\n\tmutate(gini_avg = ifelse(\n\t\tcountry_name == \"Taiwan Province of China\", 32.09833333, gini_avg)) %>%\n\tmutate(gini_latest = ifelse(\n\t\tcountry_name == \"Taiwan Province of China\", 31.48, gini_latest)) %>%\n\tfilter(!is.na(ladder_score))\n```\n:::\n\n\n*N.B...yes, I use `merge()` and not `left/right/full_join()`...I learned SAS before SQL and old habits die hard `(shrug emoji)`.*\n\n*N.B.2...Taiwan data is no longer avaialble in most WB sets, either in the spreadsheet or via the API the packages access. It is still at the WB's [Poverty & Inequality Platform](https://pip.worldbank.org/country-profiles/TWN) so I downloaded what I could and hard-coded. Why? Because I'm a little OCD when it comes to trying to minimize missing data.*\n\nAnyway...now we have to do some quick EDA on the GINI values in relation to the data we have. First I want to take a quick look at the by-country difference between the latest GINI value and the mean value for the period since 2000. We subtract the average from the latest value, do a quick `skimr` check, a density plot on the latest-average difference...\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for EDA skim & density plot\"}\n# a quick skim \nwhr23_fig2_1 %>%\n\tmutate(gini_diff = gini_latest - gini_avg) %>%\n\tselect(gini_latest, gini_avg, gini_diff) %>%\n\tskimr::skim()\n```\n\n::: {.cell-output-display}\nTable: Data summary\n\n|                         |           |\n|:------------------------|:----------|\n|Name                     |Piped data |\n|Number of rows           |137        |\n|Number of columns        |3          |\n|_______________________  |           |\n|Column type frequency:   |           |\n|numeric                  |3          |\n|________________________ |           |\n|Group variables          |None       |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|  mean|   sd|    p0|   p25|   p50|   p75|  p100|hist  |\n|:-------------|---------:|-------------:|-----:|----:|-----:|-----:|-----:|-----:|-----:|:-----|\n|gini_latest   |         7|          0.95| 36.73| 7.60| 23.20| 31.54| 35.30| 40.88| 63.00|▃▇▃▁▁ |\n|gini_avg      |         7|          0.95| 38.09| 7.88| 24.79| 32.26| 36.68| 42.71| 62.40|▆▇▅▂▁ |\n|gini_diff     |         7|          0.95| -1.37| 2.32| -8.91| -2.85| -1.00|  0.16|  4.37|▁▂▇▇▁ |\n:::\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for EDA skim & density plot\"}\n\nwhr23_fig2_1 %>%\n\tfilter(!is.na(gini_avg)) %>%\n\tmutate(gini_diff = gini_latest - gini_avg) %>%\n\tselect(country_name, gini_latest, gini_avg, gini_diff, region_whr) %>%\n\tarrange(gini_diff) %>%\n\tggplot(aes(gini_diff)) +\n\t\t\t\t \tgeom_density(fill = \"blue\") +\n\txlim(-9, 6)\n```\n\n::: {.cell-output-display}\n![](images/eda1-1.png){width=100%}\n:::\n:::\n\n\nQuick EDA observations from the skim and denisty plot:\n\n-   The GINI scale is 0 to 100, and the spread in this WHR set is 24.7 to 62.4, almost exactly as the entire panel from the WB GINI dataset.\n-   The means, medians, standard deviations, and ranges for average and latest are close enough.\n-   The difference (latest - average) looks on the denisty plot to be clustered just below 0, and the median difference is only -1, so we'll use the average.\n-   We only lose 7 countries from the set by adding GINI.\n\nSo let's use the average and see how it relates to our WHR variables by doing first a correlation matrix from the `DataExplorer` package...\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for EDA correlation\"}\nwhr23_fig2_1 %>%\n\tselect(ladder_score, standard_error_of_ladder_score, gini_avg, logged_gdp_per_capita,\n\t\t\t\t social_support:perceptions_of_corruption,\n\t\t\t\t  explained_by_log_gdp_per_capita:residual) %>%\n\tfilter(!is.na(residual)) %>%\n\tfilter(!is.na(gini_avg)) %>%\n\tDataExplorer::plot_correlation(maxcat = 5L, type = \"continuous\", geom_text_args = list(\"size\" = 3))\n```\n\n::: {.cell-output-display}\n![](images/eda2-1.png){width=100%}\n:::\n:::\n\n\n...and the `DataExplorer` scatterplots.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"code for EDA scatterplots\"}\nDataExplorer::plot_scatterplot(\n\twhr23_fig2_1 %>% select(gini_avg, ladder_score, logged_gdp_per_capita,\n\t\t\t\t\t\t\t\t\t\t\t\t\tsocial_support:perceptions_of_corruption), \n\tby = \"gini_avg\", nrow = 3L)\n```\n\n::: {.cell-output-display}\n![](images/eda3-1.png){width=100%}\n:::\n:::\n\n\nWe can see from the correlation matrix and the scatterplots that:\n\n-   There is a mild but persistent relationship between a lower GINI score (less inequality) and the measures that correlate with more happiness...the happiness ladder score itself, life expectancy, freedom to make choices, etc.\n\n-   The one negative relationship was with perceptions of corruption - that is, the higher the inequality measure in their country the more likely people answering the survey were to report that they perceived higher levels of corruption.\n\n-   And interestingly, a lower GINI index correlated to a higher GDP per capita...so maybe it's better for all to spread the wealth?\n\nThat's it for basic EDA on the data. The next post will dig a bit deeper...look at some differences by region, and I'll do a quick regression to try and predict happiness score and see how close I can get to the WHR model.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}