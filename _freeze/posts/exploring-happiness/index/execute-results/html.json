{
  "hash": "6605836a07fd70ef9be6f44a1eefa411",
  "result": {
    "markdown": "---\ntitle: \"Exploring Happiness - Part 1...EDA\"\nauthor: \"gregers kjerulf dubrow\"\ndate: '2023-11-15'\ncategories: [post, news, rstats, eda]\nimage: \"dalias_happy.jpeg\"\n---\n\n\n![](dalias_happy.jpeg){fig-align=\"left\" fig-alt=\"happy cat on a sofa.\"}\n\nWhat makes us happy?\n\nA subjective question to be sure. The things that make me happy might not do much for you, and what brings you happiness might not work for me. To each their own? Or are there some basic things that boost our collective happiness, things most of us agree are good.\n\nThere have been attempts to answer the question in a universal way, by focusing on broad quality of life measures and activities. A perfect question for social scientists to dig into, and so they have.\n\nAmong the most referenced measures is the [World Happiness Report](https://worldhappiness.report). A yearly multi-chapter report published by [Sustainable Development Solutions Network](https://www.unsdsn.org/), using responses from the [Gallup World Poll](https://www.gallup.com/178667/gallup-world-poll-work.aspx).\n\nFor this post (and at least one, maybe more to come) I want to dig into the data that has been made available. Every year the WHR research team releases data for chapter two, which has composite scores by country based on the ladder score question and some others. They add logged GDP and other data in the full chapter report. GDP is made available in the chapter data for release.\n\n[The Data]{.underline} <br> The Chapter 2 data has been consistently offered for download for years now. There are two datasets:\n\n-   Data for *Figure 1* includes the three three-year rolling average of the happiness ladder question (a 0-10 scale, described in the statistical appendix) along with related measures, aggregated by country. We also get the ladder score of a hypothetical dystopian country.\n-   Data for *Table 1* has the output of the OLS regression model to predict each country's ladder score.\n\nThe Figure 1 data also includes OLS output in form of the percent of each country's happiness score that could be attributed to the component variables. Another column in the Figure 1 set includes a column with the dystopia score plus the country's residual of the actual and predicted ladder scores. In the data loading code below you'll that added a column separating out the residual.\n\nBoth the report's [statisitcal appendix](https://happiness-report.s3.amazonaws.com/2023/WHR+23_Statistical_Appendix.pdf) (downloads a pdf) and [on-line version of Chapter 2](https://worldhappiness.report/ed/2023/world-happiness-trust-and-social-connections-in-times-of-crisis/) explain everything in more detail so I won't repeat it here.\n\n[Working with the data]{.underline} <br> I'll be using `r` for all aspects of the work; importing the data, cleaning, analysing, and visualising. So let's go...\n\nFor this post, I want to focus on Exploratory Data Analysis (EDA). It's the part of the analytical process where you get a broad overview of the data...look for things that need cleaning, look for distributions and relationships. In the past I'd build my own charts and tables, and that took quite a lot of time and mental energy.\n\nThankfully there are packages to speed up the work. So to get a quick look at this first set of WHR data, I'll test-drive the EDA packages [`DataExplorer`](https://boxuancui.github.io/DataExplorer/) by Boxuan Cui, and Roland Krasser's [`explorer`](https://rolkra.github.io/explore).\n\nTo start with let's load packages to import and clean the data. These are the three packages I use for almost every analysis in `r`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # to do tidyverse things\nlibrary(tidylog) # to get a log of what's happening to the data\nlibrary(janitor) # tools for data cleaning\n```\n:::\n\n\nTo get the WHR data into RStudio you can go two ways. First is to download the sheet to your local machine and read in:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read in WHR data, fix country names for later merges\nwhr23_fig2_1a <- readxl::read_excel(\"yourfilepath/DataForFigure2.1WHR2023.xls\") %>%\n\tclean_names() %>%\n\tas_tibble() %>%\n\tmutate(residual = dystopia_residual - ladder_score_in_dystopia) %>%\n\tselect(-residual_is_dystopia_minus_dystopia_plus_residual) %>%\n\tmutate(whr_year = 2023) %>%\n\tmutate(country_name = case_when(\n\t\tcountry_name == \"Czechia\" ~ \"Czech Republic\",\n\t\tcountry_name == \"State of Palestine\" ~ \"Palestinian Territories\",\n\t\tcountry_name ==  \"Turkiye\" ~ \"Turkey\",\n\t\tTRUE ~ country_name))\n```\n:::\n\n\nYou could also use `curl` to download straight from the WHR page:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nurl1 <- \"https://happiness-report.s3.amazonaws.com/2023/DataForFigure2.1WHR2023.xls\"\ndestfile1 <- \"DataForFigure2_1WHR2023.xls\"\ncurl::curl_download(url1, destfile1)\nwhr23_fig2_1a <- readxl::read_excel(destfile1) \n## %>% (and then the same cleaning steps shown above)\n```\n:::\n\n\nThe data from the WHR does not include the world region for each country, something I will want for further analysis. I'm not sure what the source is for the region grouping they are using. I found a file with a region column on [Kaggle for the 2021 survey](https://www.kaggle.com/datasets/ajaypalsinghlo/world-happiness-report-2021), so downloaded that and merged on country name.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read in kaggle file with region names\nctreg <- readr::read_csv(\"yourfilepath/world-happiness-report-2021.csv\") %>%\n\tas_tibble() %>%\n\tclean_names() %>%\n\tselect (country_name, region = regional_indicator)\n\n# join to whr23 on country, add missing region for Congo (Kinshasa)\nwhr23_fig2_1 <- whr23_fig2_1a %>%\n\tmerge(ctreg, all = TRUE) %>%\n\tas_tibble() %>%\n\tselect(country_name, region, whr_year, everything()) %>%\n\tmutate(region = ifelse(\n\t\tcountry_name == \"Congo (Kinshasa)\", \"Sub-Saharan Africa\", region))\n```\n:::\n\n\nAnother way to do it is to hard code them. I had to go back to the [2018 report](https://worldhappiness.report/ed/2018/#appendices-and-data) to find a list.\n\nRegardless, we now have a dataset, so let's explore it.\n\n\n\n\n\n[The `DataExplorer` package]{.underline} <br> Let's start with DataExplorer. The [`create_report()`](https://boxuancui.github.io/DataExplorer/reference/create_report.html) function runs the full set of native reports and outputs to a directory of your choosing with a filename of your choosing. But for a review I want to go through a few of the individual report elements.\n\n[`introduce()`](https://boxuancui.github.io/DataExplorer/reference/introduce.html) outputs a table showing rows, columns and other information. If you want to see this information in chart form, [`plot_intro()`](https://boxuancui.github.io/DataExplorer/reference/plot_intro.html) and [`plot_missing()`](https://boxuancui.github.io/DataExplorer/reference/plot_missing.html) do that.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## DataExplorer for EDA\nlibrary(DataExplorer) # EDA tools\n\n# summary of completes, missings\nintroduce(whr23_fig2_1)\n#> # A tibble: 1 × 9\n#>    rows columns discrete_columns continuous_columns all_missing_columns\n#>   <int>   <int>            <int>              <int>               <int>\n#> 1   150      22                2                 20                   0\n#> # ℹ 4 more variables: total_missing_values <int>, complete_rows <int>,\n#> #   total_observations <int>, memory_usage <dbl>\nplot_intro(whr23_fig2_1)\n```\n\n::: {.cell-output-display}\n![](images/eda1-1.png){width=100%}\n:::\n\n```{.r .cell-code}\nplot_missing(whr23_fig2_1)\n```\n\n::: {.cell-output-display}\n![](images/eda1-2.png){width=100%}\n:::\n:::\n\n\nThere are hardly any missing values in the set, which will make analysis easier.\n\nOk, so how about the distribution of our variables? [`plot_bar()`](https://boxuancui.github.io/DataExplorer/reference/plot_bar.html) takes all discrete variables and [`plot_histogram()`](https://boxuancui.github.io/DataExplorer/reference/plot_histogram.html) runs for the continuous variables. Depending on how many columns of each type your dataset has you will need to play with the `nrow` and `ncol` options so that everything renders to the RStudio plot column. For the histograms you can change the number of binsm change the x-axis to log or some other option (the default is continuous). You can also customize the look a bit with passing arguments to the `ggtheme =` and `theme_config()` functions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_bar(whr23_fig2_1)\n```\n\n::: {.cell-output-display}\n![](images/eda2-1.png){width=100%}\n:::\n:::\n\n\nFor the discrete variable bar charts, for this dataset there isn't much to look at. But for a dataset with demographic varaibles, geographic places, etc. this would be very helpful.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_histogram(whr23_fig2_1, nrow = 5L)\n```\n\n::: {.cell-output-display}\n![](images/eda2a-1.png){width=100%}\n:::\n:::\n\n\nThe histograms render in alpha order of the variable name, not order in the dataset. When the plots render, we look through them to see if there are any unusual skews or other things we want to watch out for depending on the type of analyses to be run. In this case there are a few solitary bars in some of the histograms, like values above 0.4 in the *generosity* column. But nothing too skewed so that if we took a closer look at distributions by way of means or interquartiles that we'd be too worried.\n\nNow for my favorite part of this package, a correlation matrix! We'll run [`plot_correlation()`](https://boxuancui.github.io/DataExplorer/reference/plot_correlation.html) without the year, dystopia ladder score, and whiskers and make sure to only do continuous. We can also adjust things like the type of correlation (default is pearson), the size of the coefficient labels in the chart and other elements.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## correlation...remove some columns, clean NA in pipe, continuous only, change text size\nwhr23_fig2_1 %>%\n\tselect(-whr_year, -ladder_score_in_dystopia, -upperwhisker, -lowerwhisker) %>%\n\tfilter(!is.na(residual)) %>%\n\tplot_correlation(type = \"continuous\", geom_text_args = list(\"size\" = 3))\n```\n\n::: {.cell-output-display}\n![](images/eda3-1.png){width=100%}\n:::\n:::\n\n\nThe way my brain works is to look for visual patterns and relationships. So a correlation matrix like this is perfect to give me a broad view of how the continuous variables relate to each other. The matrix heatmap returns positive relationships in red, negative in blue. I first want to look at the relationships of the component variables to the ladder score, and we see positive associations for everything except for perception of corruption, which makes sense because you'd likely report being less happy if you lived in a corrupt country.\n\nThe weakest association is between generosity, which comes from a question asking *\"Have you donated to charity in the past month?\"* So while donations to charity are a good thing, they don't necessarily move the needle on happiness. At least not in the aggregate. But maybe by country or region? Something to take a look at later. This is why we do EDA...\n\nWe also see that we could have run this without the \"explained by...\" columns as they have the same coefficients as the component variables.\n\nAs much as I love a correlation matrix, I love scatterplots even more. I clearly have a thing for patterns and relationships. The [`plot_scatterplot`](https://boxuancui.github.io/DataExplorer/reference/plot_scatterplot.html) function returns plots for all the variables you pass along, against the one you call in the `by =` argument. Here we want to see the association between the ladder score and component variables from Chapter 2.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_scatterplot(\n\twhr23_fig2_1 %>% select(ladder_score, social_support:perceptions_of_corruption, dystopia_residual, residual), \n\tby = \"ladder_score\", nrow = 3L)\n```\n\n::: {.cell-output-display}\n![](images/eda4-1.png){width=100%}\n:::\n:::\n\n\nWe know from the correlation heatmap that we don't need the \"explained_by\\_\\*\" variables as they were redundant to the component variables. The x/y distributions here confirm what we saw in the correlations, including the slightly negative relationship between the ladder score and perceptions of corruption, and that generosity was a weaker relationship.\n\nWhile the scatterplot function does allow for some plot customization, one I tried but couldn't get to work was using the `geom_point_args()` call to color the dots by region, like this using `ggplot`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwhr23_fig2_1 %>%\n\tggplot(aes(x = perceptions_of_corruption, y = ladder_score)) +\n\tgeom_point(aes(color = region)) +\n\ttheme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](images/eda4a-1.png){width=100%}\n:::\n:::\n\n\nThere are a few other functions offered to do principal component analysis and qq (quantile-quantile) plots, but they did not help much with this dataset.\n\nOverall there are plenty of helpful features in `DataExplorer` that make it worthwhile to use for EDA. I'd like the ability to color scatterplots by a discrete variable, or to facet the histograms or scatterplots, but as is, a robust EDA tool.\n\n[The `explore` package]{.underline} <br> The best function here is [`explore(dataset)`](https://rolkra.github.io/explore/reference/explore.html), which launches a `shiny` window with four tabs.\n\nThe \"overview\" tab shown here, displays a table with mean, min, max, and unique & missing value counts by variable.\n\n![](explore_shiny_overview.png){fig-align=\"left\" fig-alt=\"output of explore(dataset) overview tab.\"}\n\nThe \"variable\" tab allows you to explore variables on their own... ![](explore_shiny_expl1var.png){fig-align=\"left\" fig-alt=\"output of explore(dataset) variable tab area plot.\"}\n\n...or in relation to one another. ![](explore_shiny_expl2vars.png){fig-align=\"left\" fig-alt=\"output of explore(dataset) area tab area and scatter.\"} You not only get a chart appropriate to the variable type (categoricals with bars, continuous with area plots), but when you target against another variable you get a scatterplot.\n\nThe *explain* tab runs a decision tree against a target variable, and the *data* tab displays the entire dataset as a table, all rows and all columns. So before launching this you may want to be mindful of running it against too large a dataset.\n\nIf you don't want to launch the shiny app, you can output a report in html...\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## creates html report of all individual reports\nwhr23_fig2_1 %>%\n\treport(output_dir = \"~/data/World Happiness Report\")\n```\n:::\n\n\n...or run select features individually, depending on what you need....\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwhr23_fig2_1 %>%\n\tselect(ladder_score, social_support:perceptions_of_corruption,\n\t\t\t\t explained_by_log_gdp_per_capita:residual) %>%\n\tdescribe_all() \n#> select: dropped 8 variables (country_name, region, whr_year, standard_error_of_ladder_score, upperwhisker, …)\n#> # A tibble: 14 × 8\n#>    variable                          type     na na_pct unique   min  mean   max\n#>    <chr>                             <chr> <int>  <dbl>  <int> <dbl> <dbl> <dbl>\n#>  1 ladder_score                      dbl      13    8.7    138  1.86  5.54  7.8 \n#>  2 social_support                    dbl      13    8.7    138  0.34  0.8   0.98\n#>  3 healthy_life_expectancy           dbl      14    9.3    137 51.5  65.0  77.3 \n#>  4 freedom_to_make_life_choices      dbl      13    8.7    138  0.38  0.79  0.96\n#>  5 generosity                        dbl      13    8.7    138 -0.25  0.02  0.53\n#>  6 perceptions_of_corruption         dbl      13    8.7    138  0.15  0.73  0.93\n#>  7 explained_by_log_gdp_per_capita   dbl      13    8.7    138  0     1.41  2.2 \n#>  8 explained_by_social_support       dbl      13    8.7    138  0     1.16  1.62\n#>  9 explained_by_healthy_life_expect… dbl      14    9.3    137  0     0.37  0.7 \n#> 10 explained_by_freedom_to_make_lif… dbl      13    8.7    138  0     0.54  0.77\n#> 11 explained_by_generosity           dbl      13    8.7    138  0     0.15  0.42\n#> 12 explained_by_perceptions_of_corr… dbl      13    8.7    138  0     0.15  0.56\n#> 13 dystopia_residual                 dbl      14    9.3    137 -0.11  1.78  2.95\n#> 14 residual                          dbl      14    9.3    137 -1.89  0     1.18\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwhr23_fig2_1 %>%\n\texplore(ladder_score)\n```\n\n::: {.cell-output-display}\n![](images/eda7-1.png){width=100%}\n:::\n:::\n\n\nThe [main vignette](https://rolkra.github.io/explore/articles/explore.html) and [reference guide](https://rolkra.github.io/explore/reference/index.html) is very robust, so no need to repeat too much here. But there are some fun features like decision trees, and lots of flexibilty to explore multiple variables in relation to each other.\n\n[The `skimr` package]{.underline} <br> Then there is [`skimr`](https://cran.r-project.org/web/packages/skimr/vignettes/skimr.html), one of the first EDA packages that I remember seeing. If there's a feature I like most, it's the basic `skim()` function, which returns means & other distributions, as well as little histograms.\n\n-   <div>\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(skimr)\n    whr23_fig2_1 %>%\n    \tselect(ladder_score, social_support:perceptions_of_corruption, residual) %>%\n    \tskim()\n    #> select: dropped 15 variables (country_name, region, whr_year, standard_error_of_ladder_score, upperwhisker, …)\n    ```\n    \n    ::: {.cell-output-display}\n    Table: Data summary\n    \n    |                         |           |\n    |:------------------------|:----------|\n    |Name                     |Piped data |\n    |Number of rows           |150        |\n    |Number of columns        |7          |\n    |_______________________  |           |\n    |Column type frequency:   |           |\n    |numeric                  |7          |\n    |________________________ |           |\n    |Group variables          |None       |\n    \n    \n    **Variable type: numeric**\n    \n    |skim_variable                | n_missing| complete_rate|  mean|   sd|    p0|   p25|   p50|   p75|  p100|hist  |\n    |:----------------------------|---------:|-------------:|-----:|----:|-----:|-----:|-----:|-----:|-----:|:-----|\n    |ladder_score                 |        13|          0.91|  5.54| 1.14|  1.86|  4.72|  5.68|  6.33|  7.80|▁▂▆▇▃ |\n    |social_support               |        13|          0.91|  0.80| 0.13|  0.34|  0.72|  0.83|  0.90|  0.98|▁▂▃▆▇ |\n    |healthy_life_expectancy      |        14|          0.91| 64.97| 5.75| 51.53| 60.65| 65.84| 69.41| 77.28|▃▃▇▇▂ |\n    |freedom_to_make_life_choices |        13|          0.91|  0.79| 0.11|  0.38|  0.72|  0.80|  0.87|  0.96|▁▁▃▇▇ |\n    |generosity                   |        13|          0.91|  0.02| 0.14| -0.25| -0.07|  0.00|  0.12|  0.53|▃▇▅▁▁ |\n    |perceptions_of_corruption    |        13|          0.91|  0.73| 0.18|  0.15|  0.67|  0.77|  0.85|  0.93|▁▁▁▅▇ |\n    |residual                     |        14|          0.91|  0.00| 0.50| -1.89| -0.22|  0.07|  0.30|  1.18|▁▂▅▇▂ |\n    :::\n    :::\n\n\n    </div>\n\nIt's especially helpful on small and medium-sized datasets, to get a quick overview and look for outliers.\n\n[Happiness data takeaways]{.underline} \n<br> \nUsing these packages for EDA on the happiness data, we learned that: \n\n-   There are not many missing values in the data. \n* All of the component variables except generosity have strong positive correlations with the happiness score. \n-   Perception of corruption has, as expected, a negative association with happiness.\n\nWe also came away wanting to know a bit more about differences by region, so that's a good starting point for the next post, which will be a slightly deeper dive into the data.\n\n[Conclusion]{.underline} <br> There is no one perfect EDA package that suits all needs for any dataset. `DataExplorer` has some robust features, particularly in this usecase the correlation heatmap and the scatterplots. I loved the native reports and shiny app in `explorer`. I had planned to look at [`correlationfunnel`](https://business-science.github.io/correlationfunnel/), but it's only really suited to a use-case with binary outcomes such as customer sign-up, churn, employee retention, college admissions outcomes (admits, yield), student success outcomes like retention and graduation. I'll have to find another dataset to try that package. Doing these package test-drives reminded me that `skimr` is also very useful.\n\nGoing forward I'll be setting up a more deliberate EDA workflow using parts of each of these packages, depending on the size of the dataset and the main questions I'd have of the data.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}